#!/usr/bin/env bash

# OLED burn-in protection for the ThinkPad X1 Fold 16.
# Linux doesn't have Lenovo's built-in pixel shift, so we use
# aggressive DPMS timeouts and idle dimming to protect the panel.
#
# Usage:
#   x1fold-oled-protect apply     # Apply OLED-safe DPMS/idle settings
#   x1fold-oled-protect status    # Show current settings
#
# Settings applied:
#   - Screen dims after 2 minutes of inactivity
#   - Screen off (DPMS) after 3 minutes
#   - Lock screen after 5 minutes

set -euo pipefail

# Timeouts in seconds (override via env vars)
DIM_TIMEOUT="${X1FOLD_DIM_TIMEOUT:-120}"
DPMS_TIMEOUT="${X1FOLD_DPMS_TIMEOUT:-180}"
LOCK_TIMEOUT="${X1FOLD_LOCK_TIMEOUT:-300}"

apply_settings() {
    # Set Hyprland DPMS timeout via hypridle config or direct hyprctl
    # We create/update a hypridle config fragment

    local hypridle_conf="$HOME/.config/hypr/hypridle-x1fold.conf"
    mkdir -p "$(dirname "$hypridle_conf")"

    cat > "$hypridle_conf" << EOF
# X1 Fold OLED burn-in protection â€” aggressive idle timeouts
# Generated by x1fold-oled-protect

general {
    lock_cmd = hyprlock
    before_sleep_cmd = loginctl lock-session
    after_sleep_cmd = hyprctl dispatch dpms on
}

# Dim screen
listener {
    timeout = ${DIM_TIMEOUT}
    on-timeout = x1fold-brightness set 5
    on-resume = x1fold-brightness set 50
}

# Turn screen off
listener {
    timeout = ${DPMS_TIMEOUT}
    on-timeout = hyprctl dispatch dpms off
    on-resume = hyprctl dispatch dpms on
}

# Lock screen
listener {
    timeout = ${LOCK_TIMEOUT}
    on-timeout = loginctl lock-session
}
EOF

    echo "OLED protection settings written to: $hypridle_conf"
    echo ""
    echo "Timeouts:"
    echo "  Dim:    ${DIM_TIMEOUT}s ($(( DIM_TIMEOUT / 60 ))m)"
    echo "  Off:    ${DPMS_TIMEOUT}s ($(( DPMS_TIMEOUT / 60 ))m)"
    echo "  Lock:   ${LOCK_TIMEOUT}s ($(( LOCK_TIMEOUT / 60 ))m)"
    echo ""
    echo "To activate, ensure hypridle is running with this config:"
    echo "  hypridle -c $hypridle_conf"
    echo ""
    echo "Or source it from your main hypridle.conf."
}

show_status() {
    local hypridle_conf="$HOME/.config/hypr/hypridle-x1fold.conf"
    if [[ -f "$hypridle_conf" ]]; then
        echo "Config: $hypridle_conf"
        echo ""
        grep -E '(timeout|on-timeout)' "$hypridle_conf" | sed 's/^/  /'
    else
        echo "No OLED protection config found."
        echo "Run: x1fold-oled-protect apply"
    fi
}

case "${1:-apply}" in
    apply)  apply_settings ;;
    status) show_status ;;
    *)
        echo "Usage: x1fold-oled-protect [apply|status]" >&2
        exit 1
        ;;
esac
