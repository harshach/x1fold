#!/usr/bin/env bash

# One-time setup for ThinkPad X1 Fold 16 on Omarchy (Arch + Hyprland).
# Run this after installing Omarchy and cloning the x1fold repo.
#
# Usage: x1fold-setup [--uninstall]
#        x1fold-setup --boot-bluetooth    # Set up Bluetooth keyboard for LUKS unlock

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
PROJECT_ROOT="$(cd "$REPO_DIR/.." && pwd)"

HYPR_DIR="$HOME/.config/hypr"
WAYBAR_DIR="$HOME/.config/waybar"
BIN_DIR="$HOME/.local/share/omarchy/bin"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

info()  { echo -e "${GREEN}[x1fold]${NC} $*"; }
warn()  { echo -e "${YELLOW}[x1fold]${NC} $*"; }
error() { echo -e "${RED}[x1fold]${NC} $*" >&2; }

add_mkinitcpio_hook() {
    # Add a hook to the HOOKS array in mkinitcpio config files.
    # Checks both /etc/mkinitcpio.conf and any .conf.d/ drop-ins that
    # override HOOKS (Omarchy uses /etc/mkinitcpio.conf.d/omarchy_hooks.conf).
    #
    # Usage: add_mkinitcpio_hook <hook_name> <after_hook>
    #   hook_name: the hook to add (e.g. "bluetooth")
    #   after_hook: insert after this hook (e.g. "keyboard")

    local hook="$1"
    local after="$2"
    local added=false

    # Collect all config files that define HOOKS
    local configs=()
    [[ -f /etc/mkinitcpio.conf ]] && configs+=(/etc/mkinitcpio.conf)
    for f in /etc/mkinitcpio.conf.d/*.conf; do
        [[ -f "$f" ]] && grep -qE '^\s*HOOKS=' "$f" && configs+=("$f")
    done

    for conf in "${configs[@]}"; do
        if grep -qE "^\s*HOOKS=.*\b${hook}\b" "$conf"; then
            info "  ${hook} hook already present in $conf"
        elif grep -qE "^\s*HOOKS=.*\b${after}\b" "$conf"; then
            sudo sed -i -E "s/(HOOKS=.*\b${after}\b)/\1 ${hook}/" "$conf"
            info "  Added ${hook} hook after ${after} in $conf"
            added=true
        else
            warn "  Could not find '${after}' hook in $conf to insert '${hook}' after"
        fi
    done

    if [[ "$added" == true ]]; then
        return 0
    fi
    return 1
}

remove_mkinitcpio_hook() {
    # Remove a hook from HOOKS in all mkinitcpio config files.
    # Usage: remove_mkinitcpio_hook <hook_name>

    local hook="$1"

    local configs=()
    [[ -f /etc/mkinitcpio.conf ]] && configs+=(/etc/mkinitcpio.conf)
    for f in /etc/mkinitcpio.conf.d/*.conf; do
        [[ -f "$f" ]] && grep -qE '^\s*HOOKS=' "$f" && configs+=("$f")
    done

    for conf in "${configs[@]}"; do
        if grep -qE "^\s*HOOKS=.*\b${hook}\b" "$conf"; then
            sudo sed -i -E "s/ ${hook}\b//" "$conf"
            info "  Removed ${hook} hook from $conf"
        fi
    done
}

show_effective_hooks() {
    # Show the effective HOOKS line (last definition wins)
    local last_hooks
    last_hooks="$(grep -hE '^\s*HOOKS=' /etc/mkinitcpio.conf /etc/mkinitcpio.conf.d/*.conf 2>/dev/null | tail -1)"
    info "  Effective HOOKS: $last_hooks"
}

detect_aur_helper() {
    for helper in yay paru pikaur; do
        if command -v "$helper" &>/dev/null; then
            echo "$helper"
            return
        fi
    done
}

install_packages() {
    info "Installing required packages..."

    # Official repo packages
    local packages=(
        iio-sensor-proxy    # accelerometer + ambient light sensor
        fwupd               # firmware updates via LVFS
        thermald            # thermal management for Intel hybrid CPUs
        hypridle            # idle manager for OLED protection
        hyprlock            # lock screen
        linux-headers       # kernel headers for DKMS module builds
        dkms                # dynamic kernel module support
        socat               # Hyprland IPC for on-screen keyboard auto-show
    )
    local to_install=()

    for pkg in "${packages[@]}"; do
        if ! pacman -Qi "$pkg" &>/dev/null; then
            to_install+=("$pkg")
        fi
    done

    if [[ ${#to_install[@]} -gt 0 ]]; then
        sudo pacman -S --needed --noconfirm "${to_install[@]}"
    else
        info "All official packages already installed."
    fi

    # AUR packages
    local aur_packages=(
        wvkbd               # on-screen keyboard (AUR)
    )
    local aur_to_install=()

    for pkg in "${aur_packages[@]}"; do
        if ! pacman -Qi "$pkg" &>/dev/null; then
            aur_to_install+=("$pkg")
        fi
    done

    if [[ ${#aur_to_install[@]} -gt 0 ]]; then
        local aur_helper
        aur_helper="$(detect_aur_helper)"

        if [[ -z "$aur_helper" ]]; then
            error "No AUR helper found (yay, paru, or pikaur)."
            error "Install one first, then re-run setup."
            error "Packages needed from AUR: ${aur_to_install[*]}"
            exit 1
        fi

        info "Installing AUR packages via $aur_helper..."
        "$aur_helper" -S --needed --noconfirm "${aur_to_install[@]}"
    else
        info "All AUR packages already installed."
    fi
}

link_scripts() {
    info "Linking scripts to $BIN_DIR..."
    mkdir -p "$BIN_DIR"

    for script in x1fold-laptop-mode x1fold-rotate x1fold-osk x1fold-brightness x1fold-battery x1fold-oled-protect x1fold-battery-waybar x1fold-notification-focus x1fold-palm-guard; do
        local src="$REPO_DIR/bin/$script"
        local dst="$BIN_DIR/$script"

        # Clean up old symlinks from ~/.local/bin (not on Hyprland's PATH)
        local old_dst="$HOME/.local/bin/$script"
        if [[ -L "$old_dst" ]]; then
            rm -f "$old_dst"
            info "  Removed old link from ~/.local/bin/$script"
        fi

        if [[ -e "$dst" && ! -L "$dst" ]]; then
            warn "$dst exists and is not a symlink, skipping."
            continue
        fi

        chmod +x "$src"
        ln -sf "$src" "$dst"
        info "  Linked $script"
    done
}

link_configs() {
    info "Linking Hyprland configs..."
    mkdir -p "$HYPR_DIR"

    for conf in x1fold.conf x1fold-autostart.conf; do
        local src="$REPO_DIR/config/hypr/$conf"
        local dst="$HYPR_DIR/$conf"

        if [[ -e "$dst" && ! -L "$dst" ]]; then
            warn "$dst exists and is not a symlink, skipping."
            continue
        fi

        ln -sf "$src" "$dst"
        info "  Linked $conf"
    done

    # Add source line to hyprland.conf if not already present
    local hypr_conf="$HYPR_DIR/hyprland.conf"
    if [[ -f "$hypr_conf" ]]; then
        if ! grep -q "x1fold.conf" "$hypr_conf"; then
            echo "" >> "$hypr_conf"
            echo "# ThinkPad X1 Fold support" >> "$hypr_conf"
            echo "source = ~/.config/hypr/x1fold.conf" >> "$hypr_conf"
            info "  Added source line to hyprland.conf"
        else
            info "  hyprland.conf already sources x1fold.conf"
        fi
    else
        warn "hyprland.conf not found at $hypr_conf — you'll need to add this manually:"
        warn "  source = ~/.config/hypr/x1fold.conf"
    fi
}

link_waybar() {
    info "Linking Waybar config..."
    mkdir -p "$WAYBAR_DIR"

    local src="$REPO_DIR/config/waybar/x1fold-modules.json"
    local dst="$WAYBAR_DIR/x1fold-modules.json"

    if [[ -e "$dst" && ! -L "$dst" ]]; then
        warn "$dst exists and is not a symlink, skipping."
        return
    fi

    ln -sf "$src" "$dst"
    info "  Linked x1fold-modules.json"

    warn "You'll need to manually add the laptop-mode module to your waybar config."
    warn "Add \"custom/laptop-mode\" to your modules list and include the module config."
    warn "See: $src"
}

setup_oled_protection() {
    info "Setting up OLED burn-in protection..."
    "$REPO_DIR/bin/x1fold-oled-protect" apply
    info "  OLED protection configured"
}

setup_battery_thresholds() {
    info "Setting battery charge thresholds for longevity..."

    local start_thresh="/sys/class/power_supply/BAT0/charge_control_start_threshold"
    if [[ -f "$start_thresh" ]]; then
        "$REPO_DIR/bin/x1fold-battery" default
        info "  Battery thresholds set to 80/90%"
    else
        warn "  Battery charge thresholds not available (may need thinkpad_acpi module)"
        warn "  You can try: sudo modprobe thinkpad_acpi"
        warn "  Then re-run setup"
    fi

    # Persist thresholds across reboots via udev rule
    local udev_bat="/etc/udev/rules.d/90-x1fold-battery.rules"
    sudo tee "$udev_bat" >/dev/null <<'EOF'
# ThinkPad X1 Fold — battery charge thresholds for longevity
# Applied at boot when battery subsystem loads
SUBSYSTEM=="power_supply", ATTR{type}=="Battery", ATTR{charge_control_start_threshold}="80", ATTR{charge_control_end_threshold}="90"
EOF
    info "  Udev rule created to persist thresholds across reboots"
}

configure_swayosd() {
    info "Configuring swayosd for laptop mode compatibility..."

    local conf_dir="$HOME/.config/swayosd"
    local conf="$conf_dir/config.toml"

    mkdir -p "$conf_dir"

    if [[ -f "$conf" ]]; then
        if grep -q 'top_margin' "$conf"; then
            sed -i 's/^.*top_margin.*/top_margin = 0.01/' "$conf"
        else
            sed -i '/^\[server\]/a top_margin = 0.01' "$conf"
        fi
    else
        cat > "$conf" <<'EOF'
[server]
top_margin = 0.01
EOF
    fi

    info "  swayosd OSD positioned for laptop mode"
}

configure_walker() {
    info "Configuring walker for laptop mode compatibility..."

    local conf="$HOME/.config/walker/config.toml"

    if [[ ! -f "$conf" ]]; then
        warn "  Walker config not found at $conf, skipping"
        return
    fi

    if grep -q '\[shell\]' "$conf"; then
        sed -i 's/^anchor_bottom.*/anchor_bottom = false/' "$conf"
    else
        cat >> "$conf" <<'EOF'

[shell]
anchor_top = true
anchor_bottom = false
anchor_left = true
anchor_right = true
EOF
    fi

    info "  Walker menus anchored to top (not full-screen center)"
}

setup_touchpad_quirks() {
    info "Setting up libinput quirks for ThinkPad BT TrackPoint Keyboard..."

    local quirks_dir="/etc/libinput"
    local quirks_file="$quirks_dir/local-overrides.quirks"

    sudo mkdir -p "$quirks_dir"

    # Check if our section already exists
    if [[ -f "$quirks_file" ]] && grep -q 'ThinkPad BT TrackPoint Keyboard II' "$quirks_file"; then
        info "  Quirks already configured in $quirks_file"
        return
    fi

    # Append our quirks (file may have other user quirks)
    sudo tee -a "$quirks_file" >/dev/null <<'EOF'

# ThinkPad Bluetooth TrackPoint Keyboard II (17ef:613e)
#
# The X1 Fold has no built-in keyboard — this BT keyboard is the primary
# input device. Marking keyboard + touchpad as "internal" enables:
#   1. DWT (disable-while-typing) — libinput only disables internal touchpads
#      when typing on an internal keyboard
#   2. Edge palm detection — libinput enables this automatically for internal
#      touchpads (works without pressure/touch-size axes)
#
# The touchpad lacks pressure/touch-size axes, so pressure-based palm
# detection is unavailable. Edge detection + DWT are the primary defenses.

[ThinkPad BT TrackPoint Keyboard II (keyboard)]
MatchUdevType=keyboard
MatchBus=bluetooth
MatchVendor=0x17EF
MatchProduct=0x613E
AttrKeyboardIntegration=internal

[ThinkPad BT TrackPoint Keyboard II (touchpad)]
MatchUdevType=touchpad
MatchBus=bluetooth
MatchVendor=0x17EF
MatchProduct=0x613E
AttrTouchpadIntegration=internal

[ThinkPad BT TrackPoint Keyboard II (trackpoint)]
MatchUdevType=pointingstick
MatchBus=bluetooth
MatchVendor=0x17EF
MatchProduct=0x613E
AttrPointingStickIntegration=external
EOF
    info "  Quirks written to $quirks_file"
    info "  DWT + edge palm detection enabled for keyboard/touchpad pair"
}

setup_power_tuning() {
    info "Setting up power tuning for battery life..."

    # Sysctl: disable NMI watchdog, increase dirty writeback interval
    local sysctl_conf="/etc/sysctl.d/90-x1fold-power.conf"
    sudo tee "$sysctl_conf" >/dev/null <<'EOF'
# ThinkPad X1 Fold power tuning
# Disable NMI watchdog — debug feature, saves ~1W
kernel.nmi_watchdog = 0
# Increase dirty writeback interval (5s → 15s) — fewer disk wake-ups
vm.dirty_writeback_centisecs = 1500
EOF
    sudo sysctl --load="$sysctl_conf" >/dev/null
    info "  NMI watchdog disabled, writeback interval increased"

    # Udev: PCIe ASPM powersupersave + PCI runtime PM autosuspend
    local udev_conf="/etc/udev/rules.d/90-x1fold-power.rules"
    sudo tee "$udev_conf" >/dev/null <<'EOF'
# ThinkPad X1 Fold power tuning
# Enable PCIe ASPM powersupersave for deepest idle states
ACTION=="add", SUBSYSTEM=="module", KERNEL=="pcie_aspm", \
  ATTR{parameters/policy}="powersupersave"
# Auto-suspend all PCI devices after 2 seconds idle
ACTION=="add", SUBSYSTEM=="pci", \
  ATTR{power/control}="auto"
EOF
    # Apply immediately
    echo powersupersave | sudo tee /sys/module/pcie_aspm/parameters/policy >/dev/null 2>&1 || true
    for dev in /sys/bus/pci/devices/*/power/control; do
        echo auto | sudo tee "$dev" >/dev/null 2>&1 || true
    done
    info "  PCIe ASPM powersupersave enabled, PCI runtime PM set to auto"
}

uninstall_touchpad_quirks() {
    local quirks_file="/etc/libinput/local-overrides.quirks"
    if [[ -f "$quirks_file" ]] && grep -q 'ThinkPad BT TrackPoint Keyboard II' "$quirks_file"; then
        # Remove our sections (from the comment header to the next blank line after each section)
        sudo sed -i '/# ThinkPad Bluetooth TrackPoint Keyboard II/,/^$/d' "$quirks_file"
        sudo sed -i '/\[ThinkPad BT TrackPoint Keyboard II/,/^$/d' "$quirks_file"
        # Remove file if empty
        if [[ ! -s "$quirks_file" ]]; then
            sudo rm "$quirks_file"
        fi
        info "  Removed touchpad quirks"
    fi
}

uninstall_power_tuning() {
    if [[ -f /etc/sysctl.d/90-x1fold-power.conf ]]; then
        sudo rm /etc/sysctl.d/90-x1fold-power.conf
        info "  Removed power sysctl config"
    fi
    if [[ -f /etc/udev/rules.d/90-x1fold-power.rules ]]; then
        sudo rm /etc/udev/rules.d/90-x1fold-power.rules
        info "  Removed power udev rules"
    fi
    if [[ -f /etc/udev/rules.d/90-x1fold-battery.rules ]]; then
        sudo rm /etc/udev/rules.d/90-x1fold-battery.rules
        info "  Removed battery threshold udev rules"
    fi
}

enable_services() {
    info "Enabling services..."

    if ! systemctl is-enabled iio-sensor-proxy.service &>/dev/null; then
        sudo systemctl enable --now iio-sensor-proxy.service
        info "  Enabled iio-sensor-proxy"
    else
        info "  iio-sensor-proxy already enabled"
    fi

    if ! systemctl is-enabled thermald.service &>/dev/null; then
        sudo systemctl enable --now thermald.service
        info "  Enabled thermald (Intel thermal management)"
    else
        info "  thermald already enabled"
    fi

    if ! systemctl is-enabled fwupd.service &>/dev/null; then
        sudo systemctl enable fwupd.service
        info "  Enabled fwupd (firmware updates)"
    else
        info "  fwupd already enabled"
    fi
}

setup_boot_bluetooth() {
    # Set up Bluetooth keyboard support in initramfs so the keyboard
    # can be used to enter LUKS passphrase at boot.
    # Uses mkinitcpio-bluetooth from AUR.

    info "Setting up boot-time Bluetooth keyboard support..."
    echo ""

    # Check that we're not using sd-encrypt (incompatible)
    if [[ ! -f /etc/mkinitcpio.conf ]]; then
        error "/etc/mkinitcpio.conf not found. Is mkinitcpio installed?"
        exit 1
    fi
    if grep -rqE '^\s*HOOKS=.*\bsystemd\b' /etc/mkinitcpio.conf /etc/mkinitcpio.conf.d/*.conf 2>/dev/null; then
        error "Your mkinitcpio config uses the 'systemd' hook."
        error "mkinitcpio-bluetooth is NOT compatible with the systemd hook."
        error "You would need to switch from sd-encrypt to the traditional 'encrypt' hook."
        error "Aborting."
        exit 1
    fi

    # Step 1: Ensure the keyboard is paired and trusted
    info "Step 1: Verify Bluetooth keyboard is paired"
    echo ""

    if ! command -v bluetoothctl &>/dev/null; then
        sudo pacman -S --needed --noconfirm bluez bluez-utils
    fi

    # Check for paired keyboards
    local paired_devices
    paired_devices="$(bluetoothctl devices Paired 2>/dev/null || true)"

    if [[ -z "$paired_devices" ]]; then
        warn "No paired Bluetooth devices found."
        warn ""
        warn "Please pair your keyboard first:"
        warn "  1. Run: bluetoothctl"
        warn "  2. Type: scan le"
        warn "  3. Find your keyboard MAC address"
        warn "  4. Type: connect XX:XX:XX:XX:XX:XX"
        warn "  5. Accept pairing"
        warn "  6. Type: trust XX:XX:XX:XX:XX:XX"
        warn "  7. Type: scan off"
        warn "  8. Type: exit"
        warn ""
        warn "Then run this command again."
        exit 1
    fi

    info "  Found paired devices:"
    echo "$paired_devices" | while read -r line; do
        info "    $line"
    done
    echo ""

    # Step 2: Ensure AutoEnable=true in bluetooth config
    info "Step 2: Configure Bluetooth auto-enable"

    local bt_conf="/etc/bluetooth/main.conf"
    if [[ -f "$bt_conf" ]]; then
        if grep -q '^AutoEnable=true' "$bt_conf"; then
            info "  AutoEnable already set to true"
        elif grep -q '^#\?AutoEnable=' "$bt_conf"; then
            sudo sed -i 's/^#\?AutoEnable=.*/AutoEnable=true/' "$bt_conf"
            info "  Set AutoEnable=true in $bt_conf"
        else
            echo 'AutoEnable=true' | sudo tee -a "$bt_conf" >/dev/null
            info "  Added AutoEnable=true to $bt_conf"
        fi
    else
        warn "  $bt_conf not found, skipping AutoEnable configuration"
    fi
    echo ""

    # Step 3: Install mkinitcpio-bluetooth from AUR
    info "Step 3: Install mkinitcpio-bluetooth"

    if pacman -Qi mkinitcpio-bluetooth &>/dev/null; then
        info "  mkinitcpio-bluetooth already installed"
    else
        local aur_helper
        aur_helper="$(detect_aur_helper)"

        if [[ -z "$aur_helper" ]]; then
            error "No AUR helper found (yay, paru, or pikaur)."
            error "Install one first: sudo pacman -S yay"
            error "Or install mkinitcpio-bluetooth manually from the AUR."
            exit 1
        fi

        info "  Installing via $aur_helper..."
        "$aur_helper" -S --needed --noconfirm mkinitcpio-bluetooth
    fi
    echo ""

    # Step 4: Add bluetooth hook to mkinitcpio config
    info "Step 4: Add bluetooth hook to mkinitcpio config"

    if ! add_mkinitcpio_hook bluetooth keyboard; then
        # All configs already have it, or we need a fallback
        if ! grep -rqE '^\s*HOOKS=.*\bbluetooth\b' /etc/mkinitcpio.conf /etc/mkinitcpio.conf.d/*.conf 2>/dev/null; then
            error "Could not find a suitable place to insert the bluetooth hook."
            error "Please add 'bluetooth' to HOOKS manually after 'keyboard'."
            exit 1
        fi
    fi
    show_effective_hooks
    echo ""

    # Step 5: Enable bluetooth service
    info "Step 5: Enable bluetooth service"

    if ! systemctl is-enabled bluetooth.service &>/dev/null; then
        sudo systemctl enable bluetooth.service
        info "  Enabled bluetooth.service"
    else
        info "  bluetooth.service already enabled"
    fi
    echo ""

    # Step 6: Rebuild initramfs
    info "Step 6: Rebuild initramfs"
    warn "  This will regenerate initramfs with Bluetooth support."
    warn "  Your keyboard pairing data will be included."
    echo ""

    sudo mkinitcpio -P
    echo ""

    info "Boot-time Bluetooth setup complete!"
    info ""
    info "Your Bluetooth keyboard should now work at the LUKS passphrase prompt."
    info "Note: The keyboard may take a few seconds to connect at boot."
    info "You can start typing your passphrase — keystrokes will be buffered."
    info ""
    warn "Keep a USB keyboard accessible as a fallback until you've verified this works."
}

install_kernel_patch() {
    info "Installing patched thinkpad_acpi kernel module (DKMS)..."

    local patch_dir="$PROJECT_ROOT/thinkpad_acpi_patch"
    local dkms_name="thinkpad-acpi-x1fold"
    local dkms_ver="1.0"
    local dkms_src="/usr/src/${dkms_name}-${dkms_ver}"

    if ! [[ -d "$patch_dir" ]]; then
        error "Patch source not found at $patch_dir"
        return 1
    fi

    # Check if already installed
    if dkms status "${dkms_name}/${dkms_ver}" 2>/dev/null | grep -q "installed"; then
        info "  thinkpad-acpi-x1fold/1.0 already installed via DKMS"
        return
    fi

    # Copy source to DKMS location
    info "  Copying source to ${dkms_src}..."
    sudo mkdir -p "$dkms_src"
    sudo cp "$patch_dir/thinkpad_acpi.c" "$dkms_src/"
    sudo cp "$patch_dir/dual_accel_detect.h" "$dkms_src/"
    sudo cp "$patch_dir/Makefile" "$dkms_src/"
    sudo cp "$patch_dir/dkms.conf" "$dkms_src/"

    # Remove old DKMS registration if present but not installed
    if dkms status "${dkms_name}/${dkms_ver}" 2>/dev/null | grep -q "added"; then
        sudo dkms remove "${dkms_name}/${dkms_ver}" --all 2>/dev/null || true
    fi

    # Build and install
    info "  Building and installing via DKMS..."
    sudo dkms install "${dkms_name}/${dkms_ver}"

    # Reload module
    info "  Reloading thinkpad_acpi module..."
    sudo modprobe -r thinkpad_acpi 2>/dev/null || true
    sudo modprobe thinkpad_acpi

    info "  Patched thinkpad_acpi installed successfully"
    info "  DKMS will automatically rebuild on kernel updates"
}

uninstall_kernel_patch() {
    local dkms_name="thinkpad-acpi-x1fold"
    local dkms_ver="1.0"
    local dkms_src="/usr/src/${dkms_name}-${dkms_ver}"

    if dkms status "${dkms_name}/${dkms_ver}" 2>/dev/null | grep -q "${dkms_name}"; then
        info "  Removing DKMS module ${dkms_name}/${dkms_ver}..."
        sudo dkms remove "${dkms_name}/${dkms_ver}" --all 2>/dev/null || true
    fi

    if [[ -d "$dkms_src" ]]; then
        sudo rm -rf "$dkms_src"
        info "  Removed ${dkms_src}"
    fi

    sudo depmod -a
    sudo modprobe -r thinkpad_acpi 2>/dev/null || true
    sudo modprobe thinkpad_acpi 2>/dev/null || true
    info "  Original thinkpad_acpi module restored"
}

setup_hibernate() {
    info "Setting up suspend-then-hibernate..."
    echo ""

    local swapfile="/swapfile"
    local limine_conf="/etc/default/limine"
    local sleep_conf_dir="/etc/systemd/sleep.conf.d"
    local sleep_conf="$sleep_conf_dir/x1fold.conf"
    local logind_conf="/etc/systemd/logind.conf"

    # Step 1: Create swap file if it doesn't exist
    if [[ -f "$swapfile" ]]; then
        info "  Swap file already exists at $swapfile"
    else
        info "  Creating 32 GB swap file..."
        sudo btrfs filesystem mkswapfile --size 32G "$swapfile"
        info "  Swap file created"
    fi

    # Enable swap if not already active
    if ! swapon --show=NAME --noheadings | grep -q "^$swapfile$"; then
        sudo swapon "$swapfile"
        info "  Swap file enabled"
    else
        info "  Swap file already active"
    fi

    # Add to fstab if not present
    if ! grep -q "$swapfile" /etc/fstab; then
        echo "$swapfile none swap defaults 0 0" | sudo tee -a /etc/fstab >/dev/null
        info "  Added swap file to /etc/fstab"
    else
        info "  Swap file already in /etc/fstab"
    fi
    echo ""

    # Step 2: Get resume offset
    info "  Getting resume offset..."
    local resume_offset
    resume_offset="$(sudo btrfs inspect-internal map-swapfile "$swapfile")"

    # map-swapfile may output just the number, or a line like "resume offset: 12345"
    resume_offset="$(echo "$resume_offset" | grep -oE '[0-9]+' | tail -1)"

    if [[ -z "$resume_offset" ]]; then
        error "Failed to get resume offset from btrfs inspect-internal map-swapfile"
        error "Run manually: sudo btrfs inspect-internal map-swapfile $swapfile"
        return 1
    fi
    info "  Resume offset: $resume_offset"
    echo ""

    # Step 3: Add resume hook to mkinitcpio config
    info "  Configuring mkinitcpio resume hook..."
    if ! add_mkinitcpio_hook resume encrypt; then
        if ! grep -rqE '^\s*HOOKS=.*\bresume\b' /etc/mkinitcpio.conf /etc/mkinitcpio.conf.d/*.conf 2>/dev/null; then
            error "Could not find a suitable place to insert the resume hook."
            error "Please add 'resume' to HOOKS manually after 'encrypt'."
            return 1
        fi
    fi
    show_effective_hooks
    echo ""

    # Step 4: Add resume parameters to bootloader
    info "  Configuring bootloader resume parameters..."
    local resume_line="resume=/dev/mapper/root resume_offset=$resume_offset"
    if grep -q "resume=/dev/mapper/root" "$limine_conf"; then
        # Update existing resume_offset in case it changed
        sudo sed -i -E "s|resume_offset=[0-9]+|resume_offset=$resume_offset|" "$limine_conf"
        info "  Updated resume_offset in $limine_conf"
    else
        # Append resume params
        echo "KERNEL_CMDLINE[default]+=\" $resume_line\"" | sudo tee -a "$limine_conf" >/dev/null
        info "  Added resume parameters to $limine_conf"
    fi
    echo ""

    # Step 5: Configure systemd sleep
    info "  Configuring systemd sleep (hibernate after 30 min)..."
    sudo mkdir -p "$sleep_conf_dir"
    sudo tee "$sleep_conf" >/dev/null <<'EOF'
[Sleep]
HibernateDelaySec=30min
EOF
    info "  Created $sleep_conf"
    echo ""

    # Step 6: Configure logind for lid close
    info "  Configuring logind lid switch behavior..."
    if grep -q '^HandleLidSwitch=suspend-then-hibernate' "$logind_conf"; then
        info "  HandleLidSwitch already set"
    else
        sudo sed -i 's/^#\?HandleLidSwitch=.*/HandleLidSwitch=suspend-then-hibernate/' "$logind_conf"
        info "  Set HandleLidSwitch=suspend-then-hibernate"
    fi
    if grep -q '^HandleLidSwitchExternalPower=suspend-then-hibernate' "$logind_conf"; then
        info "  HandleLidSwitchExternalPower already set"
    else
        sudo sed -i 's/^#\?HandleLidSwitchExternalPower=.*/HandleLidSwitchExternalPower=suspend-then-hibernate/' "$logind_conf"
        info "  Set HandleLidSwitchExternalPower=suspend-then-hibernate"
    fi
    echo ""

    # Step 7: Rebuild initramfs and update bootloader
    info "  Rebuilding initramfs..."
    sudo mkinitcpio -P
    echo ""
    info "  Updating bootloader..."
    sudo limine-update
    echo ""

    info "Suspend-then-hibernate setup complete!"
    info ""
    info "  Swap file:     $swapfile (32 GB)"
    info "  Resume device: /dev/mapper/root"
    info "  Resume offset: $resume_offset"
    info "  Hibernate delay: 30 minutes after suspend"
    info "  Lid close:     suspend-then-hibernate"
    info ""
    info "Verification:"
    info "  swapon --show                    # should show /swapfile"
    info "  cat /sys/power/disk              # should show [platform]"
    info "  cat /proc/cmdline                # should contain resume= params"
    info "  sudo systemctl hibernate         # test hibernate (after reboot)"
    info ""
    warn "Reboot required for kernel cmdline changes to take effect."
}

uninstall_hibernate() {
    info "Removing suspend-then-hibernate configuration..."

    local swapfile="/swapfile"
    local limine_conf="/etc/default/limine"
    local sleep_conf="/etc/systemd/sleep.conf.d/x1fold.conf"
    local logind_conf="/etc/systemd/logind.conf"
    local changed=false

    # Remove swap file
    if swapon --show=NAME --noheadings | grep -q "^$swapfile$"; then
        sudo swapoff "$swapfile"
        info "  Disabled swap file"
    fi
    if [[ -f "$swapfile" ]]; then
        sudo rm "$swapfile"
        info "  Removed $swapfile"
    fi

    # Remove from fstab
    if grep -q "$swapfile" /etc/fstab; then
        sudo sed -i "\|$swapfile|d" /etc/fstab
        info "  Removed swap file from /etc/fstab"
    fi

    # Remove resume hook from all mkinitcpio configs
    remove_mkinitcpio_hook resume
    changed=true

    # Remove resume parameters from limine config
    if grep -q "resume=/dev/mapper/root" "$limine_conf"; then
        sudo sed -i '/resume=\/dev\/mapper\/root/d' "$limine_conf"
        info "  Removed resume parameters from $limine_conf"
        changed=true
    fi

    # Remove sleep config
    if [[ -f "$sleep_conf" ]]; then
        sudo rm "$sleep_conf"
        info "  Removed $sleep_conf"
    fi

    # Revert logind lid switch settings
    if grep -q '^HandleLidSwitch=suspend-then-hibernate' "$logind_conf"; then
        sudo sed -i 's/^HandleLidSwitch=suspend-then-hibernate/#HandleLidSwitch=suspend/' "$logind_conf"
        info "  Reverted HandleLidSwitch to default"
    fi
    if grep -q '^HandleLidSwitchExternalPower=suspend-then-hibernate' "$logind_conf"; then
        sudo sed -i 's/^HandleLidSwitchExternalPower=suspend-then-hibernate/#HandleLidSwitchExternalPower=suspend/' "$logind_conf"
        info "  Reverted HandleLidSwitchExternalPower to default"
    fi

    # Rebuild initramfs and update bootloader if we changed hooks/cmdline
    if [[ "$changed" == true ]]; then
        info "  Rebuilding initramfs..."
        sudo mkinitcpio -P
        info "  Updating bootloader..."
        sudo limine-update
    fi

    info "  Hibernate configuration removed"
    warn "Reboot required for kernel cmdline changes to take effect."
}

do_install() {
    info "Setting up ThinkPad X1 Fold for Omarchy..."
    echo ""

    install_packages
    echo ""
    link_scripts
    echo ""
    link_configs
    echo ""
    link_waybar
    echo ""
    setup_oled_protection
    echo ""
    setup_battery_thresholds
    echo ""
    setup_touchpad_quirks
    echo ""
    install_kernel_patch
    echo ""
    configure_swayosd
    echo ""
    configure_walker
    echo ""
    setup_power_tuning
    echo ""
    setup_hibernate
    echo ""
    enable_services

    echo ""
    info "Setup complete!"
    info ""
    info "What's configured:"
    info "  - Auto-rotation via accelerometer"
    info "  - On-screen keyboard (auto-shows without physical keyboard)"
    info "  - HiDPI scaling at 1.6x with XWayland fix"
    info "  - Pen/stylus support (Wacom AES)"
    info "  - Touchscreen gestures (3-finger swipe for workspaces)"
    info "  - OLED burn-in protection (dim/off/lock timeouts)"
    info "  - Auto-brightness via ambient light sensor"
    info "  - Battery charge thresholds (80/90% for longevity)"
    info "  - Touchpad palm guard (extended DWT + edge palm detection)"
    info "  - Magnetic keyboard dock detection (patched thinkpad_acpi)"
    info "  - Power tuning (ASPM powersupersave, NMI watchdog off, PCI autosuspend)"
    info "  - Suspend-then-hibernate (s2idle 30min → hibernate for zero battery drain)"
    info "  - Intel thermal management (thermald)"
    info "  - Firmware update support (fwupd)"
    info ""
    info "Keybindings:"
    info "  Super+Shift+L  Toggle laptop mode"
    info "  Super+Shift+K  Toggle on-screen keyboard"
    info ""
    info "Useful commands:"
    info "  x1fold-battery status     Check battery thresholds"
    info "  x1fold-battery full       Temporarily charge to 100%"
    info "  x1fold-brightness get     Check current brightness"
    info "  fwupdmgr get-updates      Check for firmware updates"
    info ""
    info "If the monitor name isn't eDP-1, check with 'hyprctl monitors'"
    info "and set X1FOLD_MONITOR in your shell profile."
    info ""
    info "To also enable Bluetooth keyboard at boot (for LUKS unlock):"
    info "  x1fold-setup --boot-bluetooth"
}

do_all() {
    do_install
    echo ""
    echo "============================================"
    echo ""
    setup_boot_bluetooth
}

do_uninstall() {
    info "Removing ThinkPad X1 Fold configuration..."

    uninstall_kernel_patch
    uninstall_power_tuning
    uninstall_touchpad_quirks
    uninstall_hibernate

    # Stop palm guard if running
    x1fold-palm-guard stop 2>/dev/null || true

    for script in x1fold-laptop-mode x1fold-rotate x1fold-osk x1fold-brightness x1fold-battery x1fold-oled-protect x1fold-battery-waybar x1fold-notification-focus x1fold-palm-guard; do
        local dst="$BIN_DIR/$script"
        if [[ -L "$dst" ]]; then
            rm "$dst"
            info "  Removed $script"
        fi
    done

    # Remove generated hypridle config
    if [[ -f "$HYPR_DIR/hypridle-x1fold.conf" ]]; then
        rm "$HYPR_DIR/hypridle-x1fold.conf"
        info "  Removed hypridle-x1fold.conf"
    fi

    for conf in x1fold.conf x1fold-autostart.conf; do
        local dst="$HYPR_DIR/$conf"
        if [[ -L "$dst" ]]; then
            rm "$dst"
            info "  Removed $conf"
        fi
    done

    local dst="$WAYBAR_DIR/x1fold-modules.json"
    if [[ -L "$dst" ]]; then
        rm "$dst"
        info "  Removed x1fold-modules.json"
    fi

    warn "You may want to remove the 'source = ~/.config/hypr/x1fold.conf' line from hyprland.conf"

    info "Uninstall complete."
}

case "${1:-}" in
    --all)              do_all ;;
    --hibernate)        setup_hibernate ;;
    --boot-bluetooth)   setup_boot_bluetooth ;;
    --uninstall)        do_uninstall ;;
    ""|--install)       do_install ;;
    *)
        echo "Usage: x1fold-setup [--all|--install|--hibernate|--boot-bluetooth|--uninstall]" >&2
        echo ""
        echo "  (default)          Install configs, scripts, and packages"
        echo "  --all              Install everything + boot-time Bluetooth"
        echo "  --hibernate        Set up suspend-then-hibernate (swap file + resume)"
        echo "  --boot-bluetooth   Set up Bluetooth keyboard for LUKS unlock at boot"
        echo "  --uninstall        Remove x1fold configs and symlinks"
        exit 1
        ;;
esac
